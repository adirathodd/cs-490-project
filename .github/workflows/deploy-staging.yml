name: Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: staging-deployment
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '22'
  ENVIRONMENT: staging

jobs:
  # ============================================
  # Run Tests Before Deployment
  # ============================================
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    
    outputs:
      test-passed: ${{ steps.test.outcome == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest-cov

      - name: Run tests
        id: test
        env:
          DJANGO_TEST: '1'
          DJANGO_SECRET_KEY: 'test-secret-key-for-ci'
        run: |
          cd backend
          pytest --ds=backend.settings --disable-warnings -v \
            --cov=core --cov-report=xml

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    
    outputs:
      test-passed: ${{ steps.test.outcome == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run tests
        id: test
        working-directory: frontend
        env:
          CI: true
        run: npm test -- --runInBand --watchAll=false --passWithNoTests

      - name: Build check
        working-directory: frontend
        env:
          CI: false
          REACT_APP_API_URL: ${{ secrets.STAGING_API_URL }}
        run: npm run build

  # ============================================
  # Deploy Backend to Staging
  # ============================================
  deploy-backend-staging:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: always() && (needs.test-backend.result == 'success' || github.event.inputs.skip_tests == 'true') && (needs.test-frontend.result == 'success' || github.event.inputs.skip_tests == 'true')
    environment: staging
    
    outputs:
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
      deployment-url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Record deployment start
        id: start
        run: |
          echo "start-time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "commit-sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Deploy to Render Staging
        id: deploy
        env:
          RENDER_STAGING_DEPLOY_HOOK: ${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}
        run: |
          DEPLOYMENT_ID="${{ github.run_id }}-backend-staging"
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          
          if [ -n "$RENDER_STAGING_DEPLOY_HOOK" ]; then
            response=$(curl -s -w "%{http_code}" -X POST "$RENDER_STAGING_DEPLOY_HOOK")
            http_code="${response: -3}"
            
            if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
              echo "✅ Triggered Render staging deployment"
              echo "url=${{ secrets.STAGING_API_URL }}" >> $GITHUB_OUTPUT
            else
              echo "❌ Deployment trigger failed with HTTP $http_code"
              exit 1
            fi
          else
            echo "⚠️ RENDER_STAGING_DEPLOY_HOOK not set, simulating deployment"
            echo "url=https://staging-api.example.com" >> $GITHUB_OUTPUT
          fi

      - name: Wait for deployment
        run: |
          echo "Waiting 60 seconds for deployment to propagate..."
          sleep 60

      - name: Health check
        id: health
        run: |
          STAGING_URL="${{ secrets.STAGING_API_URL || 'https://staging-api.example.com' }}"
          
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL/api/health/" 2>/dev/null || echo "000")
            if [ "$response" = "200" ]; then
              echo "✅ Health check passed"
              exit 0
            fi
            echo "Attempt $i: Health check returned $response, retrying..."
            sleep 10
          done
          
          echo "⚠️ Health check inconclusive - deployment may still be in progress"

  # ============================================
  # Deploy Frontend to Staging
  # ============================================
  deploy-frontend-staging:
    name: Deploy Frontend to Staging
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: always() && (needs.test-backend.result == 'success' || github.event.inputs.skip_tests == 'true') && (needs.test-frontend.result == 'success' || github.event.inputs.skip_tests == 'true')
    environment: staging
    
    outputs:
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
      deployment-url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build for staging
        working-directory: frontend
        env:
          CI: false
          REACT_APP_API_URL: ${{ secrets.STAGING_API_URL }}
          REACT_APP_ENVIRONMENT: staging
        run: npm run build

      - name: Deploy to Vercel Staging
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          DEPLOYMENT_ID="${{ github.run_id }}-frontend-staging"
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          
          if [ -n "$VERCEL_TOKEN" ]; then
            cd frontend
            npm install -g vercel
            DEPLOYMENT_URL=$(vercel --token=$VERCEL_TOKEN --yes --env preview 2>/dev/null || echo "")
            
            if [ -n "$DEPLOYMENT_URL" ]; then
              echo "✅ Deployed to: $DEPLOYMENT_URL"
              echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            else
              echo "⚠️ Vercel deployment may be handled by GitHub integration"
              echo "url=${{ secrets.STAGING_FRONTEND_URL }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "ℹ️ Vercel auto-deploys on push via GitHub integration"
            echo "url=${{ secrets.STAGING_FRONTEND_URL }}" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Notify Team
  # ============================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-backend-staging, deploy-frontend-staging]
    if: always()
    
    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [ "${{ needs.deploy-backend-staging.result }}" = "success" ] && [ "${{ needs.deploy-frontend-staging.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
            echo "message=Staging deployment completed successfully" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
            echo "message=Staging deployment failed" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.status.outputs.status }}' === 'success' ? 'success' : 'failure';
            
            try {
              const deployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha,
                environment: 'staging',
                auto_merge: false,
                required_contexts: []
              });
              
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.data.id,
                state: status,
                environment_url: '${{ needs.deploy-frontend-staging.outputs.deployment-url }}',
                description: '${{ steps.status.outputs.message }}'
              });
            } catch (error) {
              console.log('Could not create deployment status:', error.message);
            }

  # ============================================
  # Record Deployment Metrics
  # ============================================
  record-metrics:
    name: Record Deployment Metrics
    runs-on: ubuntu-latest
    needs: [deploy-backend-staging, deploy-frontend-staging, notify]
    if: always()
    
    steps:
      - name: Record deployment metrics
        env:
          API_URL: ${{ secrets.STAGING_API_URL }}
          DEPLOYMENT_API_KEY: ${{ secrets.DEPLOYMENT_API_KEY }}
        run: |
          # Calculate deployment duration
          START_TIME="${{ github.event.head_commit.timestamp }}"
          END_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Record metrics if API is available
          if [ -n "$API_URL" ] && [ -n "$DEPLOYMENT_API_KEY" ]; then
            curl -X POST "$API_URL/api/deployments/" \
              -H "Authorization: Bearer $DEPLOYMENT_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"environment\": \"staging\",
                \"commit_sha\": \"${{ github.sha }}\",
                \"commit_message\": \"${{ github.event.head_commit.message }}\",
                \"branch\": \"${{ github.ref_name }}\",
                \"deployed_by\": \"${{ github.actor }}\",
                \"status\": \"${{ needs.deploy-backend-staging.result == 'success' && needs.deploy-frontend-staging.result == 'success' && 'success' || 'failed' }}\",
                \"workflow_run_id\": \"${{ github.run_id }}\",
                \"started_at\": \"$START_TIME\",
                \"completed_at\": \"$END_TIME\"
              }" || echo "Could not record deployment metrics"
          fi
          
          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Staging |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Status | ${{ needs.deploy-backend-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Status | ${{ needs.deploy-frontend-staging.result }} |" >> $GITHUB_STEP_SUMMARY
